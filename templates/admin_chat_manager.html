{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">
    <h1 class="mb-4">ðŸ’¬ Chat Manager</h1>
    <p class="text-muted">Total Unread Messages: <span class="badge bg-danger">{{ total_unread }}</span></p>

    <div class="row">
        <!-- Left Side: Chat List -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Active Chats</h5>
                </div>
                <div class="card-body p-0">
                    {% if chat_sessions %}
                    <div class="list-group list-group-flush">
                        {% for session in chat_sessions %}
                        <a href="{{ url_for('admin_chat_manager') }}?user_id={{ session.user.id }}" 
                           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if selected_user and selected_user.id == session.user.id %}active{% endif %}">
                            <div>
                                <h6 class="mb-1">{{ session.user.username }}</h6>
                                <small class="{% if selected_user and selected_user.id == session.user.id %}text-white{% else %}text-muted{% endif %}">
                                    {{ session.user.email }}
                                </small>
                                <br>
                                <small class="{% if selected_user and selected_user.id == session.user.id %}text-white-50{% else %}text-muted{% endif %}">
                                    Last: {{ session.updated_at.strftime('%Y-%m-%d %H:%M') }}
                                </small>
                            </div>
                            {% if session.unread_count > 0 %}
                            <span class="badge bg-primary rounded-pill">{{ session.unread_count }}</span>
                            {% endif %}
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-3 text-center">
                        <p class="text-muted mb-0">No active chats found.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Side: Chat Interface -->
        <div class="col-md-8">
            {% if selected_user %}
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Chat with {{ selected_user.username }}</h5>
                    <span class="badge bg-light text-dark">{{ selected_user.email }}</span>
                </div>
                <div class="card-body chat-body" style="height: 500px; overflow-y: scroll;" id="chat-messages">
                    {% for message in messages %}
                        <div class="d-flex mb-2 {% if message.is_admin_message %}justify-content-end{% endif %}">
                            <div class="alert {% if message.is_admin_message %}alert-primary{% else %}alert-secondary{% endif %} mb-0" style="max-width: 70%;">
                                <strong>{% if message.is_admin_message %}You{% else %}{{ selected_user.username }}{% endif %}:</strong>
                                {{ message.content }}
                                <br><small class="text-muted">{{ message.timestamp.strftime('%H:%M') }}</small>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Type your message..." id="message-input">
                        <input type="hidden" id="target-user-id" value="{{ selected_user.id }}">
                        <input type="hidden" id="session-id" value="{{ selected_session.id }}">
                        <button class="btn btn-primary" type="button" id="send-button">Send</button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card">
                <div class="card-body text-center">
                    <div class="py-5">
                        <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Select a chat to start messaging</h5>
                        <p class="text-muted">Choose a user from the left panel to view and respond to messages</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Include Socket.IO -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();

    // Function to scroll chat to the bottom
    function scrollToBottom() {
        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // Scroll on initial load if chat is open
    {% if selected_user %}
    scrollToBottom();
    
    // Mark messages as read when the admin opens the chat
    socket.emit('mark_messages_read', { 
        user_id: {{ selected_user.id }}, 
        session_id: {{ selected_session.id }} 
    });

    // Handle sending a message
    document.getElementById('send-button').addEventListener('click', sendMessage);
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        if (message) {
            // Emit the message to the server
            socket.emit('send_message', {
                user_id: {{ selected_user.id }},
                session_id: {{ selected_session.id }},
                content: message
            });
            input.value = ''; // Clear the input field
        }
    }

    // Listen for new messages
    socket.on('receive_message', function(data) {
        // Only add messages for this specific chat session
        if(data.session_id == {{ selected_session.id }}) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `d-flex mb-2 ${data.is_admin ? 'justify-content-end' : ''}`;

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${data.is_admin ? 'alert-primary' : 'alert-secondary'} mb-0`;
            alertDiv.style.maxWidth = '70%';
            alertDiv.innerHTML = `<strong>${data.is_admin ? 'You' : '{{ selected_user.username }}'}:</strong> ${data.content} <br><small class="text-muted">${data.timestamp}</small>`;

            messageDiv.appendChild(alertDiv);
            chatMessages.appendChild(messageDiv);

            scrollToBottom(); // Scroll to the new message

            // Update unread count in the list if message is from user
            if (!data.is_admin) {
                // You could add logic here to update the badge count
                // For now, we'll just reload the page to update counts
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }
    });
    {% endif %}

    // Listen for new messages to update the unread count in real-time
    socket.on('receive_message', function(data) {
        if (!data.is_admin) { // If the message is from a user
            // Update the page to refresh unread counts
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    });
</script>
{% endblock %}