{% extends "base.html" %} 
{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">ğŸŒ Available Tour Packages</h2>
    <div class="row">
        {% for package in packages %}
        <div class="col-md-4">
            <div class="card shadow-sm border-0 rounded-lg mb-4 h-100">
                {% if package.image_filename %}
                <img src="{{ url_for('static', filename='uploads/' ~ package.image_filename) }}" 
                     class="card-img-top rounded-top" 
                     alt="{{ package.title }}" 
                     style="height:200px; object-fit:cover;">
                {% else %}
                <img src="{{ url_for('static', filename='images/default-tour.jpg') }}" 
                     class="card-img-top rounded-top" 
                     alt="Default Tour"
                     style="height:200px; object-fit:cover;">
                {% endif %}

                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ package.title }}</h5>
                    <p class="card-text text-muted mb-1">
                        <i class="fa-solid fa-location-dot"></i> {{ package.location }}
                    </p>
                    <p class="mb-1"><i class="fa-solid fa-clock"></i> {{ package.duration }}</p>
                    <p class="mb-1"><i class="fa-solid fa-users"></i> Available Slots: 
                        <span id="available-{{ package.id }}">{{ package.available_slots }}</span>
                    </p>
                    <p class="fw-bold text-success">ğŸ’² {{ package.price }}</p>

                    <!-- Button trigger modal -->
                    <button type="button" class="btn btn-primary mt-auto w-100" 
                            data-bs-toggle="modal" 
                            data-bs-target="#packageModal{{ package.id }}">
                        View Details
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal for this package -->
        <div class="modal fade" id="packageModal{{ package.id }}" tabindex="-1" aria-labelledby="packageModalLabel{{ package.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="packageModalLabel{{ package.id }}">{{ package.title }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                {% if package.image_filename %}
                <img src="{{ url_for('static', filename='uploads/' ~ package.image_filename) }}" 
                     class="img-fluid rounded mb-3 w-100" 
                     alt="{{ package.title }}" style="max-height:300px; object-fit:cover;">
                {% endif %}

                <ul class="list-unstyled">
                  <li><strong>ğŸ“ Location:</strong> {{ package.location }}</li>
                  <li><strong>ğŸ’² Price:</strong> {{ package.price }}</li>
                  <li><strong>â³ Duration:</strong> {{ package.duration }}</li>
                  <li><strong>ğŸ‘¥ Available Slots:</strong> <span id="modal-available-{{ package.id }}">{{ package.available_slots }}</span></li>
                  <li><strong>ğŸ¨ Hotel:</strong> {{ package.hotel_name }} ({{ package.room_type }}, Rooms: {{ package.number_of_rooms }})</li>
                  <li><strong>ğŸ›  Facilities:</strong> {{ package.facilities }}</li>
                  <li><strong>ğŸšŒ Transport:</strong> {{ package.transportation_details }}</li>
                  <li><strong>ğŸ¯ Tour Type:</strong> {{ package.tour_type }}</li>
                </ul>
                <hr>
                <p>{{ package.description }}</p>

                <!-- Booking Form -->
                <div class="mb-3">
                    <label for="members-{{ package.id }}" class="form-label">Number of Members</label>
                    <input type="number" class="form-control" id="members-{{ package.id }}" min="1" max="{{ package.available_slots }}" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button class="btn btn-success book-btn" data-package="{{ package.id }}">Book Now</button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Handle booking
    document.querySelectorAll('.book-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const packageId = this.dataset.package;
            const membersInput = document.getElementById('members-' + packageId);
            const members = parseInt(membersInput.value);

            if(!members || members <= 0) {
                alert("Please enter a valid number of members.");
                return;
            }

            fetch(`/book_package/${packageId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({members: members})
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    alert("Booking confirmed!");
                    // Update available slots
                    document.getElementById('available-' + packageId).innerText = data.remaining_slots;
                    document.getElementById('modal-available-' + packageId).innerText = data.remaining_slots;
                    membersInput.max = data.remaining_slots;
                    membersInput.value = '';
                } else {
                    alert(data.message || "Booking failed!");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Something went wrong!");
            });
        });
    });
});
</script>
{% endblock %}
