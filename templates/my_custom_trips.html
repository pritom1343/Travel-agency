{% extends "base.html" %}
{% block content %}
<style>
  body { background-color: #f0f2f5; }
  .container {
    max-width: 1200px;
    margin: auto;
    background: #fff;
    padding: 25px 30px;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  }
  h2 { text-align: center; color: #007bff; margin-bottom: 25px; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { padding: 12px; text-align: center; font-size: 14px; border-bottom: 1px solid #eee; }
  th { background: #007bff; color: #fff; font-weight: 500; }
  tr:hover { background: #f1f7ff; }
  .btn { padding: 6px 14px; font-size: 13px; border-radius: 6px; margin: 2px; }
  .btn-edit { background: #28a745; color: #fff; }
  .btn-delete { background: #dc3545; color: #fff; }
  .btn-warning { background: #ffc107; color: #000; }
  .btn-dashboard { display:block; width:max-content; margin:20px auto 0; padding:10px 20px; background:#007bff; color:#fff; border-radius:8px; text-decoration:none; }
  .refund-details { font-size: 12px; margin-top: 4px; color: #555; text-align: left; }
</style>

<div class="container">
  <h2>My Custom Trips</h2>

  {% if trips %}
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Destination</th><th>Transport</th><th>Hotel</th>
          <th>Rooms</th><th>Room Type</th><th>People</th><th>Start</th>
          <th>End</th><th>Preferences</th><th>Notes</th><th>Status</th>
          <th>Price</th><th>Admin Notes</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for trip in trips %}
        <tr>
          <td>{{ trip.id }}</td>
          <td>{{ trip.destination }}</td>
          <td>{{ trip.transport }}</td>
          <td>{{ trip.hotel }}</td>
          <td>{{ trip.number_of_rooms or 'N/A' }}</td>
          <td>{{ trip.room_type or 'N/A' }}</td>
          <td>{{ trip.people }}</td>
          <td>{{ trip.start_date }}</td>
          <td>{{ trip.end_date }}</td>
          <td>{{ trip.other_preferences or 'N/A' }}</td>
          <td>{{ trip.notes or 'N/A' }}</td>
          <td>
            {% set colors = {"Pending":"text-warning","Approved":"text-success","Confirmed":"text-primary","Rejected":"text-danger"} %}
            <span class="{{ colors.get(trip.status,'text-muted') }} fw-bold">{{ trip.status }}</span>
          </td>
          <td>{{ trip.price or 'N/A' }}</td>
          <td>{{ trip.admin_notes or 'N/A' }}</td>
          <td>
            {% if trip.status == "Pending" %}
              <a href="{{ url_for('edit_custom_trip', trip_id=trip.id) }}" class="btn btn-edit">Edit</a>
              <a href="{{ url_for('delete_custom_trip', trip_id=trip.id) }}" class="btn btn-delete"
                 onclick="return confirm('Delete this trip?');">Delete</a>
            {% elif trip.status == "Approved" %}
              <form method="POST" action="{{ url_for('confirm_custom_trip', trip_id=trip.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-edit">Confirm</button>
              </form>
              <a href="{{ url_for('edit_custom_trip', trip_id=trip.id) }}" class="btn btn-edit">Resubmit</a>
              <a href="{{ url_for('delete_custom_trip', trip_id=trip.id) }}" class="btn btn-delete"
                 onclick="return confirm('Delete this trip?');">Delete</a>
            {% elif trip.status == "Confirmed" and trip.bookings %}
              {% set booking = trip.bookings[0] %}
              {% set refund = booking.refunds[0] if booking.refunds %}
              {% if refund %}
                <span class="badge bg-{{ 'success' if refund.status=='Approved' else 'info' if refund.status=='Pending' else 'danger' }}">
                  {{ 'Refunded' if refund.status=='Approved' else 'Refund Requested' if refund.status=='Pending' else 'Refund Rejected' }}
                </span>
                {% if refund.admin_notes or refund.transaction_number %}
                <div class="refund-details">
                  {% if refund.transaction_number %}<div>Trx: {{ refund.transaction_number }}</div>{% endif %}
                  {% if refund.admin_notes %}<div>Notes: {{ refund.admin_notes }}</div>{% endif %}
                </div>
                {% endif %}
              {% elif booking.can_request_refund() %}
                <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#refundModal{{ booking.id }}">Request Refund</button>
              {% else %}
                <span class="badge bg-secondary">Refund Expired</span>
              {% endif %}
            {% elif trip.status == "Rejected" %}
              <a href="{{ url_for('edit_custom_trip', trip_id=trip.id) }}" class="btn btn-edit">Resubmit</a>
              <a href="{{ url_for('delete_custom_trip', trip_id=trip.id) }}" class="btn btn-delete"
                 onclick="return confirm('Delete this trip?');">Delete</a>
            {% endif %}
          </td>
        </tr>

        <!-- Refund Modal -->
        {% if trip.status == "Confirmed" and trip.bookings %}
          {% set booking = trip.bookings[0] %}
          {% if booking and booking.can_request_refund() and not booking.refunds %}
          <div class="modal fade" id="refundModal{{ booking.id }}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <form method="POST" action="{{ url_for('request_refund', booking_id=booking.id) }}">
                  <div class="modal-header">
                    <h5 class="modal-title">Request Refund for Trip #{{ trip.id }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p>Refund Amount: <strong>à§³{{ booking.final_amount }}</strong></p>
                    <textarea class="form-control" name="reason" rows="3" required placeholder="Why do you want a refund?"></textarea>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Submit</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          {% endif %}
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="text-center text-muted">You don't have any custom trips yet.</p>
  {% endif %}

  <a href="{{ url_for('user_dashboard') }}" class="btn-dashboard">Dashboard</a>
</div>
{% endblock %}
